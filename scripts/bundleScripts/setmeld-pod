#!/usr/bin/env bash
set -euo pipefail

# Defaults (CSS)
ROOT_FILE_PATH="/var/lib/setmeld/data"
PORT="3000"
BASE_URL=""
SOCKET=""
LOGGING_LEVEL="info"
CONFIG="/usr/lib/setmeld-pod/config/config.json"
SPARQL_ENDPOINT=""
SHOW_STACK_TRACE="false"
POD_CONFIG_JSON=""
SEED_CONFIG=""
MAIN_MODULE_PATH=""
WORKERS="1"

# Orchestrator
GIT_PORT="2222"
NODE_BIN="${NODE_BIN:-/usr/lib/setmeld-pod/runtime/bin/node}"
APP_DIR="/usr/lib/setmeld-pod"
REPO_SUB=".internal/integration-git"
ENV_FILE="/etc/setmeld-pod/config.env"

[[ -f "$ENV_FILE" ]] && source "$ENV_FILE"

FORWARD_ARGS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -f|--rootFilePath) ROOT_FILE_PATH="$2"; shift 2;;
    -p|--port)         PORT="$2"; shift 2;;
    -b|--baseUrl)      BASE_URL="$2"; shift 2;;
       --socket)       SOCKET="$2"; shift 2;;
    -l|--loggingLevel) LOGGING_LEVEL="$2"; shift 2;;
    -c|--config)       CONFIG="$2"; shift 2;;
    -s|--sparqlEndpoint) SPARQL_ENDPOINT="$2"; shift 2;;
    -t|--showStackTrace) SHOW_STACK_TRACE="true"; shift 1;;
       --podConfigJson)  POD_CONFIG_JSON="$2"; shift 2;;
       --seedConfig)     SEED_CONFIG="$2"; shift 2;;
    -m|--mainModulePath) MAIN_MODULE_PATH="$2"; shift 2;;
    -w|--workers)        WORKERS="$2"; shift 2;;
       --git-port)       GIT_PORT="$2"; shift 2;;
    --) shift; break;;
    *)  FORWARD_ARGS+=("$1"); shift;;
  esac
done
FORWARD_ARGS+=("$@")
[[ -z "$BASE_URL" ]] && BASE_URL="http://localhost:${PORT}/"

# Repo root
mkdir -p "${ROOT_FILE_PATH}/${REPO_SUB}"
chown -R git:git "${ROOT_FILE_PATH}"

# Dedicated SSHD config
SSHD_DIR="/etc/setmeld-pod/sshd"
HOST_KEYS_DIR="${SSHD_DIR}/hostkeys"
mkdir -p "${HOST_KEYS_DIR}"
[[ -f "${HOST_KEYS_DIR}/ssh_host_ed25519_key" ]] || ssh-keygen -t ed25519 -N "" -f "${HOST_KEYS_DIR}/ssh_host_ed25519_key"

SSHD_CONFIG="${SSHD_DIR}/sshd_config"
cat > "$SSHD_CONFIG" <<EOF
Port ${GIT_PORT}
Protocol 2
HostKey ${HOST_KEYS_DIR}/ssh_host_ed25519_key
UsePAM no
PasswordAuthentication no
PubkeyAuthentication yes
PermitTTY no
AllowTcpForwarding no
X11Forwarding no
AuthorizedKeysFile /etc/setmeld-pod/authorized_keys
PidFile /run/setmeld-pod-git-sshd.pid
SetEnv GIT_PROJECT_ROOT=${ROOT_FILE_PATH}/${REPO_SUB}
Match User git
    ForceCommand git-shell -c "\$SSH_ORIGINAL_COMMAND"
EOF

# Launch CSS
cd "$APP_DIR"
CSS_CMD=( "./node_modules/@solid/community-server/bin/server.js"
          -c "${CONFIG}" -m "${MAIN_MODULE_PATH:-./}" -f "${ROOT_FILE_PATH}" )
[[ -n "$PORT" ]]                 && CSS_CMD+=( --port "$PORT" )
[[ -n "$BASE_URL" ]]             && CSS_CMD+=( --baseUrl "$BASE_URL" )
[[ -n "$SOCKET" ]]               && CSS_CMD+=( --socket "$SOCKET" )
[[ -n "$LOGGING_LEVEL" ]]        && CSS_CMD+=( --loggingLevel "$LOGGING_LEVEL" )
[[ -n "$SPARQL_ENDPOINT" ]]      && CSS_CMD+=( --sparqlEndpoint "$SPARQL_ENDPOINT" )
[[ "$SHOW_STACK_TRACE" == "true" ]] && CSS_CMD+=( --showStackTrace )
[[ -n "$POD_CONFIG_JSON" ]]      && CSS_CMD+=( --podConfigJson "$POD_CONFIG_JSON" )
[[ -n "$SEED_CONFIG" ]]          && CSS_CMD+=( --seedConfig "$SEED_CONFIG" )
[[ -n "$WORKERS" ]]              && CSS_CMD+=( --workers "$WORKERS" )

exec ${NODE_BIN} "${CSS_CMD[@]}" ${NODE_EXTRA_ARGS:-} "${FORWARD_ARGS[@]}"
